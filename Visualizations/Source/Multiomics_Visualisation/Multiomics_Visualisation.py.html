#!/usr/bin/env python
# coding: utf-8

# # Multiomics Visualisation
# 
# ## Table of contents
# 1. [Information for biologists](#biologists)
# 2. [Information for bioinformaticians](#bioinformaticians)
# 3. [Plotting steps](#plotting)
#     1. [Reformat the input data](#plotting)
# 
# 
# ## UpSetPlots
# 
# ### Information for biologists <a name="biologists"></a>
# UpSetPlots are a visualisation method which can be interpreted as a quantitative venn diagram. [More information on the method can be found in the original 2014 publication](https://rdcu.be/bO4oV), and a [sample interactive UpSetPlot on unrelated data is available here](https://vdl.sci.utah.edu/upset2/embed.html#{"NavBar":false,"FilterBox":false,"DataSetInfo":false,"LeftSideBar":true,"RightSideBar":false,"ProvenanceView":false,"DeviationBars":true,"CardinalityBars":true}).
# 
# ### Information for biolnformaticians <a name="bioinformaticians"></a>
# Implementations exist in [javascript](https://github.com/VCG/upset), [python](https://pypi.org/project/UpSetPlot/) and [R](https://github.com/hms-dbmi/UpSetR). For this `python` implementation the requirements are:
# 
# ```
# jupyter=1.0.0
# matplotlib=3.1.0
# pandas=0.24.2
# python=3.7.3
# upsetplot=0.3.0
# ```
# [OPTIONAL] If using this jupyter notebook in a `conda` or other virtual environment environment, the following library can be used to easily switch kernels:
# ```
# nb_conda=2.2.1
# ```

# ## Plotting steps <a name="plotting"></a>
# 
# The aim is to plot the intersection of KEGG pathways across multi-omics data.

# In[1]:


import pandas
from matplotlib import pyplot as plt
from upsetplot import from_contents, from_memberships, plot, generate_counts, UpSet
#get_ipython().run_line_magic('matplotlib', 'inline')


# ### Reformat the input data <a name="reformat"></a>
# 
# Reformatting the input data is straightforward:
#     1. Load input data as a pandas dataframe
#     2. Extract the required fields
#     3. Summarise information where needed
#     4. Convert the input data to a dictionary
#     5. Convert the dictionary to an input for upsetplot

# For the input data, we use information generated previously in the file `KEGG_Fisher_Exact_test_all_results.tsv`, `MD5 ec4faa14d08cf6f9ffc4631192127b3a`.
# 
# #### Load input data as a pandas dataframe
# 
# Here is how the input data looks like:

# In[2]:


infile_path = "KEGG_Fisher_Exact_test_all_results.tsv"

data = pandas.read_csv(infile_path, sep="\t")

data


# #### Extract the required fields
# 
# The fields of interest are the type of experiment `Type_of_Experiment` and kegg pathways `kegg_pathway_name`. The index will be the bacterial strain `Species` + `Strain`.

# In[3]:


print("".join(["Quantity of experiment types: ", str(len(data.Type_of_Experiment.unique()))]))
print("".join(["Quantity of KEGG pathways: ", str(len(data.kegg_pathway_name.unique()))]))


# In[ ]:


# glue the species and strain into a separate column
data["Species_Strain_Type_of_Experiment"] = data["Species"] + " " + data["Strain"] + " " + data["Type_of_Experiment"]

# filter out the data of interest
omics_kegg = data.loc[ : , ['Species_Strain_Type_of_Experiment', 'kegg_pathway_name'] ]

# for this part we look only at the gene pathways of interest
omics_kegg.drop_duplicates(inplace=True)
collapse_kegg = lambda x: "|".join(x).split("|")
omics_kegg = omics_kegg.groupby(omics_kegg['Species_Strain_Type_of_Experiment']).aggregate({'kegg_pathway_name':collapse_kegg})
omics_kegg = omics_kegg.to_dict()['kegg_pathway_name']
omics_kegg = from_contents(omics_kegg)
omics_kegg
upset = UpSet(omics_kegg, subset_size='count', intersection_plot_elements=3)
upset.plot()
plt.show()


# In[7]:


# example code
import numpy
contents = {'cat1': ['a', 'b', 'c'],
            'cat2': ['b', 'd'],
            'cat3': ['e']}
x = from_contents(contents)
#print(x)
y = from_memberships([
    ['cat1', 'cat3'],
    ['cat2', 'cat3'],
    ['cat1'],
    []
], data=numpy.arange(12).reshape(4, 3))
y

example = generate_counts()
plot(example)
example


# In[12]:


import pandas as pd
from sklearn.datasets import load_boston
from matplotlib import pyplot as plt
from upsetplot import UpSet

# Load the dataset into a DataFrame
boston = load_boston()
boston_df = pd.DataFrame(boston.data, columns=boston.feature_names)

# Get five features most correlated with median house value
correls = boston_df.corrwith(pd.Series(boston.target),
                             method='spearman').sort_values()
top_features = correls.index[-5:]

# Get a binary indicator of whether each top feature is above average
boston_above_avg = boston_df > boston_df.median(axis=0)
boston_above_avg = boston_above_avg[top_features]
boston_above_avg = boston_above_avg.rename(columns=lambda x: x + '>')

# Make this indicator mask an index of boston_df
boston_df = pd.concat([boston_df, boston_above_avg],
                      axis=1)
boston_df = boston_df.set_index(list(boston_above_avg.columns))

# Also give us access to the target (median house value)
boston_df = boston_df.assign(median_value=boston.target)

# UpSet plot it!
upset = UpSet(boston_df, subset_size='count', intersection_plot_elements=3)
upset.add_catplot(value='median_value', kind='strip', color='blue')
upset.add_catplot(value='AGE', kind='strip', color='black')
upset.plot()
plt.show()


# In[13]:


boston_df


# In[ ]:




